<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TrMoiX</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --bg: #000; --card: #111; --text: #fff; --accent: #0f0; --red: #f00;
      --gray: #888; --border: #222; --hover: #1a1a1a; --blue: #1DA1F2;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow: hidden; }
    a { text-decoration: none; color: inherit; }

    .header { position: fixed; top: 0; width: 100%; z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--card); border-bottom: 1px solid var(--border); }
    .logo { font-size: 22px; font-weight: bold; }
    .menu-btn { font-size: 28px; cursor: pointer; }

    .tabs { position: fixed; top: 60px; width: 100%; z-index: 99; display: flex; background: var(--card); border-bottom: 1px solid var(--border); }
    .tab { flex: 1; text-align: center; padding: 12px; font-size: 15px; color: #aaa; cursor: pointer; transition: 0.2s; }
    .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 99; }
    .overlay.active { display: block; }

    .sidebar { position: fixed; top: 0; left: -320px; width: 320px; height: 100%; background: var(--card); transition: 0.3s; z-index: 100; padding-top: 70px; border-right: 1px solid var(--border); }
    .sidebar.open { left: 0; }
    .profile { text-align: center; padding: 20px; }
    .avatar { width: 80px; height: 80px; background: #444; border-radius: 50%; margin: 0 auto 10px; background-size: cover; }
    .username { font-weight: bold; margin: 10px 0; }
    .bio { font-size: 14px; color: #aaa; }

    .menu-item { padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
    .menu-item:hover { background: var(--hover); }
    .menu-item i { font-size: 20px; }

    .feed { position: fixed; top: 100px; bottom: 70px; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
    .short { width: 100%; height: 100vh; scroll-snap-align: start; position: relative; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .short video, .short img { width: 100%; height: 100%; object-fit: contain; }

    .post-info { position: absolute; bottom: 100px; left: 15px; color: #fff; max-width: 70%; }
    .post-user { font-weight: bold; font-size: 16px; }
    .verified { position: relative; display: inline-block; margin-left: 5px; cursor: help; }
    .verified::after { content: 'Check'; background: var(--blue); color: white; font-size: 12px; width: 16px; height: 16px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-left: 3px; }
    .verified.gray::after { background: var(--gray); }
    .verified.red::after { background: var(--red); content: 'A'; }
    .tooltip { position: absolute; bottom: 25px; left: 0; background: #333; color: #fff; padding: 5px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 10; }
    .verified:hover .tooltip, .verified.touched .tooltip { opacity: 1; }

    .actions { position: absolute; right: 15px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; }
    .action-btn { background: rgba(0,0,0,0.6); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 24px; cursor: pointer; }
    .action-btn.liked { color: #f00; }
    .action-count { text-align: center; font-size: 12px; margin-top: 5px; }

    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid var(--border); z-index: 100; }
    .nav-item { text-align: center; font-size: 12px; color: #aaa; cursor: pointer; }
    .nav-item.active { color: var(--accent); }
    .nav-item i { font-size: 24px; display: block; margin-bottom: 5px; }

    .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: var(--card); width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; z-index: 101; transition: 0.3s; }
    .popup.active { transform: translate(-50%, -50%) scale(1); }
    .popup input, .popup textarea, .popup select, .popup button { width: 100%; padding: 10px; background: #333; color: #fff; border: none; border-radius: 8px; margin: 8px 0; }
    .popup button { background: var(--accent); color: #000; cursor: pointer; }

    .auth-form { max-width: 400px; margin: 100px auto; padding: 20px; background: var(--card); border-radius: 12px; }

    .profile-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 98; display: none; overflow-y: scroll; }
    .profile-page.active { display: block; }
    .profile-header { padding: 80px 20px 20px; text-align: center; }
    .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background: #444; margin: 0 auto 10px; }
    .profile-name { font-size: 20px; font-weight: bold; }
    .profile-bio { color: #aaa; margin: 10px 0; }
    .profile-stats { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
    .stat { text-align: center; }
    .stat-num { font-weight: bold; }
    .stat-label { font-size: 12px; color: #aaa; }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo">TrMoiX</div>
    <div class="menu-btn" onclick="toggleMenu()">Menu</div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('fyp')">Dành Cho Bạn</div>
    <div class="tab" onclick="switchTab('following')">Đang Follow</div>
  </div>

  <div class="overlay" onclick="toggleMenu()"></div>

  <div class="sidebar" id="sidebar">
    <div class="profile">
      <div class="avatar" id="sidebar-avatar" onclick="showProfile()"></div>
      <div class="username" id="sidebar-username">Loading...</div>
      <div class="bio" id="sidebar-bio">Chưa có bio</div>
    </div>
    <div class="menu-item" onclick="showProfile()">Profile</div>
    <div class="menu-item" onclick="openPopup('settings')">Settings</div>
    <div class="menu-item" onclick="logout()">Log Out</div>
  </div>

  <div class="feed" id="feed"></div>

  <div class="profile-page" id="profile-page">
    <div class="profile-header">
      <div class="profile-avatar" id="profile-avatar"></div>
      <div class="profile-name" id="profile-name">TriKanKai</div>
      <div class="profile-bio" id="profile-bio">Admin TrMoiX</div>
      <div class="profile-stats">
        <div class="stat"><div class="stat-num">0</div><div class="stat-label">Bài viết</div></div>
        <div class="stat"><div class="stat-num">1.2K</div><div class="stat-label">Follower</div></div>
        <div class="stat"><div class="stat-num">89</div><div class="stat-label">Following</div></div>
      </div>
      <button onclick="openPopup('upload')">Đăng Video</button>
    </div>
    <div id="profile-posts" style="padding:20px;"></div>
  </div>

  <div id="auth-container">
    <div class="auth-form" id="login-form">
      <h2>Đăng Nhập</h2>
      <input type="text" id="login-user" placeholder="Tên đăng nhập" />
      <input type="password" id="login-pass" placeholder="Mật khẩu" />
      <button onclick="login()">Đăng Nhập</button>
      <p style="text-align:center;">Chưa có? <a href="#" onclick="showAuth('register')">Đăng ký</a></p>
    </div>
    <div class="auth-form" id="register-form" style="display:none;">
      <h2>Đăng Ký</h2>
      <input type="text" id="reg-user" placeholder="Tên đăng nhập" />
      <input type="email" id="reg-email" placeholder="Email" />
      <input type="password" id="reg-pass" placeholder="Mật khẩu" />
      <button onclick="register()">Đăng Ký</button>
    </div>
  </div>

  <div class="popup" id="upload-popup">
    <h3>Đăng Video / Ảnh</h3>
    <input type="file" id="upload-file" accept="video/*,image/*" />
    <textarea id="upload-caption" placeholder="Mô tả..."></textarea>
    <button onclick="uploadPost()">Đăng</button>
    <button onclick="closePopup()">Hủy</button>
  </div>

  <div class="popup" id="settings-popup">
    <h3>Settings</h3>
    <div style="max-height:70vh;overflow-y:auto;padding:10px;">
      <div style="margin:15px 0;"><b>1 Account</b></div>
      <div style="padding:8px 0;">1.1 Tài Khoản <span>@TriKanKai</span></div>
      <div style="padding:8px 0;">1.2 Email <span>admin@trmoix.wuaze.com</span></div>
      <div style="padding:8px 0;">1.3 Google <span style="color:#f00;text-decoration:underline;">Chưa liên kết</span></div>
    </div>
    <button onclick="closePopup()">Đóng</button>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="showFeed()">Home</div>
    <div class="nav-item" onclick="switchTab('fyp')">Dành Cho Bạn</div>
    <div class="nav-item" onclick="openPopup('upload')">Đăng</div>
    <div class="nav-item" onclick="switchTab('following')">Follow</div>
    <div class="nav-item" onclick="showProfile()">Tôi</div>
  </div>

  <script>
    const API_URL = 'api/upload.php';
    const FEED_URL = 'api/feed.php';
    let currentUser = null;
    let lastPostId = 0;

    // Load user from localStorage
    function load() {
      currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (currentUser) document.getElementById('auth-container').style.display = 'none';
      initAdmin();
      updateUI();
      renderFeed();
      setInterval(pollFeed, 10000);
    }

    // Auto create admin if not exists
    function initAdmin() {
      if (!localStorage.getItem('admin_init')) {
        const admin = { username: 'TriKanKai', password: 'Triexemoi0204@', role: 'admin', verified: 'red', bio: 'Admin TrMoiX' };
        localStorage.setItem('currentUser', JSON.stringify(admin));
        localStorage.setItem('admin_init', 'true');
        currentUser = admin;
      }
    }

    // Login
    function login() {
      const u = document.getElementById('login-user').value.trim();
      const p = document.getElementById('login-pass').value;
      if (!u || !p) return alert('Nhập đầy đủ!');
      currentUser = { username: u, password: p, role: 'user', verified: 'gray', bio: 'Người dùng mới' };
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      document.getElementById('auth-container').style.display = 'none';
      updateUI();
      showFeed();
    }

    // Register
    function register() {
      const u = document.getElementById('reg-user').value.trim();
      if (!u) return alert('Nhập tên!');
      currentUser = { username: u, password: document.getElementById('reg-pass').value, role: 'user', verified: 'gray', bio: 'Người dùng mới' };
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      document.getElementById('auth-container').style.display = 'none';
      updateUI();
      showFeed();
    }

    // Logout
    function logout() {
      if (confirm('Đăng xuất?')) {
        localStorage.removeItem('currentUser');
        location.reload();
      }
    }

    // Update UI
    function updateUI() {
      if (currentUser) {
        document.getElementById('sidebar-username').textContent = currentUser.username;
        document.getElementById('sidebar-bio').textContent = currentUser.bio || 'Chưa có bio';
      }
    }

    // Toggle menu
    function toggleMenu() {
      document.getElementById('sidebar').classList.toggle('open');
      document.querySelector('.overlay').classList.toggle('active');
    }

    // Switch tab
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
    }

    // Show feed
    function showFeed() {
      document.getElementById('feed').style.display = 'block';
      document.getElementById('profile-page').classList.remove('active');
      renderFeed();
    }

    // Show profile
    function showProfile() {
      document.getElementById('feed').style.display = 'none';
      document.getElementById('profile-page').classList.add('active');
      renderProfile();
    }

    // Render profile
    async function renderProfile() {
      const user = currentUser;
      document.getElementById('profile-name').textContent = user.username;
      document.getElementById('profile-bio').textContent = user.bio || 'Chưa có bio';
      const res = await fetch(FEED_URL);
      const posts = await res.json();
      const userPosts = posts.filter(p => p.user === user.username);
      document.getElementById('profile-posts').innerHTML = userPosts.map(p => `
        <div style="margin:10px 0;">
          ${p.url.includes('video') ? `<video src="${p.url}" controls style="width:100%;max-height:300px;"></video>` : `<img src="${p.url}" style="width:100%;max-height:300px;">`}
          <p>${p.caption}</p>
        </div>
      `).join('') || '<p style="text-align:center;color:#aaa;">Chưa có bài đăng</p>';
    }

    // Upload post
    async function uploadPost() {
      const file = document.getElementById('upload-file').files[0];
      const caption = document.getElementById('upload-caption').value;
      if (!file) return alert('Chọn file!');
      const form = new FormData();
      form.append('file', file);
      form.append('caption', caption);
      form.append('user', currentUser.username);
      form.append('verified', currentUser.verified || 'gray');
      const res = await fetch(API_URL, { method: 'POST', body: form });
      const data = await res.json();
      if (data.success) {
        closePopup();
        alert('Đăng thành công! Sẽ hiện trong 10-15s');
      } else {
        alert('Lỗi: ' + (data.error || 'Không thể đăng'));
      }
    }

    // Render feed
    async function renderFeed() {
      const feed = document.getElementById('feed');
      feed.innerHTML = '';
      const res = await fetch(FEED_URL + '?since=' + lastPostId);
      const posts = await res.json();
      posts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'short';
        div.innerHTML = `
          ${p.url.includes('video') ? `<video src="${p.url}" controls autoplay loop></video>` : `<img src="${p.url}">`}
          <div class="post-info">
            <div class="post-user">@${p.user} <span class="verified ${p.verified}" 
                 ontouchstart="this.classList.add('touched')" ontouchend="this.classList.remove('touched')">
              <span class="tooltip">
                ${p.verified === 'blue' ? 'Xác Minh Người Nổi Tiếng' :
                  p.verified === 'gray' ? 'Người nổi tiếng từ app khác' :
                  'Admin (Account TriKanKai)'}
              </span>
            </span></div>
            <div>${p.caption}</div>
          </div>
          <div class="actions">
            <div class="action-btn">Heart</div>
            <div class="action-count">0</div>
          </div>
        `;
        feed.appendChild(div);
        lastPostId = Math.max(lastPostId, p.id);
      });
    }

    // Poll feed
    async function pollFeed() {
      await renderFeed();
      if (document.getElementById('profile-page').classList.contains('active')) renderProfile();
    }

    // Open/close popup
    function openPopup(id) {
      document.getElementById(id + '-popup').classList.add('active');
    }
    function closePopup() {
      document.querySelectorAll('.popup').forEach(p => p.classList.remove('active'));
    }

    function showAuth(form) {
      document.getElementById('login-form').style.display = form === 'login' ? 'block' : 'none';
      document.getElementById('register-form').style.display = form === 'register' ? 'block' : 'none';
    }

    // Start
    load();
  </script>
</body>
  </html>
